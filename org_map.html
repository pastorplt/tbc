<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>TBC Organizations Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />

  <style>
    html, body { height: 100%; margin: 0; }
    #map { height: calc(100% - 60px); }

    /* ===== Header / Nav (unchanged) ===== */
    header { background-color: #bf3426; color: #fff; }
    .nav { height: 60px; display: flex; align-items: center; gap: 16px; padding: 0 16px; max-width: 1100px; margin: 0 auto; }
    .nav .brand { display: flex; align-items: center; gap: 10px; text-decoration: none; color: #fff; font-weight: 800; letter-spacing: .3px; }
    .nav .brand img { height: 36px; width: auto; display: block; }
    .nav-links { display: flex; align-items: center; gap: 18px; margin-left: auto; }
    .nav-links a { color: #fff; text-decoration: none; font-weight: 700; padding: 6px 4px; border-radius: 4px; opacity: .9; }
    .nav-links a:hover { text-decoration: underline; opacity: 1; }
    .nav-links a.active { text-decoration: underline; opacity: 1; }
    .nav, .nav a, .nav .brand { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif !important; }

    /* Title chip */
    .map-title {
      position: absolute; top: 70px; left: 50%; transform: translateX(-50%);
      z-index: 1000;
      font: 40px/1.2 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      font-weight: 800; color: #111; text-align: center;
      background: rgba(255,255,255,0.9);
      padding: 14px 25px; border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      pointer-events: none;
    }

    .leaflet-interactive { cursor: pointer; }

    /* ===== Legend / Filters ===== */
    .legend-panel {
      position: absolute; top: 70px; left: 10px;
      width: 300px; max-height: calc(100% - 90px);
      overflow-y: auto; z-index: 1000;
      background: rgba(255,255,255,0.95);
      border: 1px solid #e5e7eb; border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      padding: 10px;
      font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y;
    }
    .legend-panel.closed { display: none; }
    .legend-header { display: none; }
    .legend-title { font-weight: 700; font-size: 14px; margin: 4px 0 8px; color: #111; }

    details { margin-bottom: 8px; border-radius: 8px; background: #f8fafc; border: 1px solid #e5e7eb; padding: 6px 8px; }
    details[open] { background: #eef2ff; }
    summary { list-style: none; cursor: pointer; display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 6px 4px; font-weight: 600; }
    summary::-webkit-details-marker { display: none; }
    .chev { transition: transform .2s ease; }
    details[open] .chev { transform: rotate(90deg); }

    .tag-list { display: grid; grid-template-columns: 1fr; gap: 6px; margin-top: 8px; }
    .tag-pill { display: inline-flex; align-items: center; gap: 8px; border: 1px solid #e3e6ef; border-radius: 999px; padding: 6px 10px; background: #fff; font-size: 13px; user-select: none; cursor: pointer; }
    .tag-pill input { cursor: pointer; }

    .panel-actions { display: flex; gap: 8px; padding-top: 8px; margin-top: 8px; border-top: 1px solid #e5e7eb; }
    .btn { border: 1px solid #d9deea; background: #fff; padding: 8px 12px; border-radius: 10px; font-size: 13px; cursor: pointer; }
    .btn-primary { border-color: #3b82f6; background: #3b82f6; color: #fff; }

    /* ===== Popup content & chips ===== */
    .popup { font: 13px/1.35 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; min-width: 240px; max-width: 360px; color: #111; }
    .popup h3 { font-size: 15px; margin: 0 0 6px; font-weight: 700; }
    .field-row { margin: 4px 0; }
    .field-row b { font-weight: 600; }
    .tag-strip { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 6px; }
    .chip { display: inline-block; padding: 4px 10px; border-radius: 999px; border: 1px solid transparent; font-size: 12px; line-height: 1.1; }
    .chip-colored { color: #fff; }
    .tag-pill.colored { border-color: transparent; }

    .popup hr { border:0; border-top:1px solid #e9ecef; margin:8px 0; }

    /* Show toggle on ALL viewports */
    .legend-toggle {
      display: inline-flex; align-items: center; justify-content: center;
      position: fixed; left: 12px; bottom: 12px; z-index: 1001;
      background: #111; color: #fff; border: 0;
      border-radius: 999px; padding: 10px 14px; font: 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      box-shadow: 0 6px 18px rgba(0,0,0,.2);
    }
    .legend-toggle:active { transform: translateY(1px); }

    /* ===== Mobile-only bottom sheet (from networks map) ===== */
    .sheet{ position: fixed; inset:0; z-index:1002; display:none; }
    .sheet.open{ display:block; }
    .sheet-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.35); }
    .sheet-panel{ position:absolute; left:0; right:0; bottom:0; background:#fff; border-radius:16px 16px 0 0; box-shadow: 0 -6px 24px rgba(0,0,0,.25); max-height:85vh; overflow:auto; padding:16px; }
    .sheet-close{ position:absolute; top:8px; right:8px; border:0; background:#f3f4f6; border-radius:999px; width:32px; height:32px; font-size:18px; }
    .sheet .tip{ font-size:14px; }
    .sheet .tip-name{ font-size:18px; margin-bottom:4px; }
    .sheet .actions{ margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; }
    .sheet .actions a{ color:#0a58ca; text-decoration:underline; font-weight:700; }
    @media (min-width: 768px){ .sheet{ display:none !important; } } /* only show on mobile */

    /* Mobile */
    @media (max-width: 767.98px) {
      .map-title { font-size: 22px; padding: 10px 16px; border-radius: 14px; }
      .legend-panel {
        position: fixed; top: 0; bottom: 0; left: 0; right: auto;
        width: 50vw; max-width: none; height: 100vh;
        border-radius: 0 12px 12px 0; padding: 8px 10px 12px;
        transform: translateX(-100%); transition: transform 220ms ease;
        border-left: 0; border-right: 1px solid #e5e7eb;
        box-shadow: 0 4px 16px rgba(0,0,0,.12);
        background: rgba(255,255,255,0.98);
        -webkit-overflow-scrolling: touch; overscroll-behavior: contain; touch-action: pan-y;
      }
      .legend-panel.open { transform: translateX(0); }

      .legend-header {
        display: flex; align-items: center; justify-content: space-between;
        gap: 8px; padding: 6px 2px 8px; position: sticky; top: 0;
        background: rgba(255,255,255,0.98); z-index: 2;
      }
      .legend-grabber { width: 40px; height: 4px; border-radius: 2px; background: #cbd5e1; margin: 4px auto 8px auto; }
      .legend-title { margin: 0 0 8px; }
      .legend-close-btn { border: none; background: #f3f4f6; color: #111; border-radius: 8px; padding: 6px 10px; font-size: 12px; cursor: pointer; }
      .legend-close-btn:active { transform: translateY(1px); }

      .desktop-only { display: none; }
      .leaflet-control-zoom { display: none !important; }
    }

    .leaflet-control-layers .basemap-heading,
    .leaflet-control-layers .overlays-heading { font-weight: 600; margin-bottom: 4px; display: block; }

    /* Make popup links clickable (no event swallowing) */
    .leaflet-popup-content a, .leaflet-popup-content button{ pointer-events:auto; }
  </style>
</head>
<body>
  <div id="navbar-include"></div>
  <script src="include-nav.js"></script>

  <div id="map">
    <div class="map-title">TBC Organizations</div>

    <button id="legendToggle" class="legend-toggle" type="button" aria-expanded="false" aria-controls="legendPanel">
      Filters
    </button>

    <aside class="legend-panel" id="legendPanel" aria-label="Filters">
      <div class="legend-header">
        <div class="legend-grabber" aria-hidden="true"></div>
        <div class="legend-title">Filters</div>
        <button class="legend-close-btn" type="button" id="legendClose">Close</button>
      </div>
      <div class="legend-title desktop-only">Filters</div>

      <details id="grp-county"><summary><span>County</span><span class="chev">▶</span></summary><div class="tag-list" id="list-county"></div></details>
      <details id="grp-network"><summary><span>Network Name</span><span class="chev">▶</span></summary><div class="tag-list" id="list-network"></div></details>
      <details id="grp-type"><summary><span>Organization Type</span><span class="chev">▶</span></summary><div class="tag-list" id="list-type"></div></details>
      <details id="grp-category"><summary><span>Category</span><span class="chev">▶</span></summary><div class="tag-list" id="list-category"></div></details>
      <details id="grp-denomination"><summary><span>Denomination</span><span class="chev">▶</span></summary><div class="tag-list" id="list-denomination"></div></details>

      <div class="panel-actions">
        <button class="btn" id="clearFilters">Clear filters</button>
        <button class="btn btn-primary" id="applyFilters">Apply</button>
      </div>
    </aside>
  </div>

  <!-- Mobile info sheet (modal) -->
  <div id="infoSheet" class="sheet" aria-hidden="true">
    <div class="sheet-backdrop" data-close="1"></div>
    <div class="sheet-panel" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <button class="sheet-close" type="button" data-close="1" aria-label="Close">×</button>
      <div id="sheetContent"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    // ===== Basemaps =====
    const esriGray = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const cartoPositron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { maxZoom: 20, subdomains: 'abcd', attribution: '&copy; OpenStreetMap contributors &copy; CARTO' });
    const esriWorldStreet = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });
    const esriTopo = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', { maxZoom: 20, attribution: 'Tiles &copy; Esri' });

    const map = L.map('map', {
      center: [37.8, -122.3], zoom: 9, layers: [esriGray], preferCanvas: true, zoomControl: false
    });
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    const baseMaps = { 'Light': esriGray, 'Medium': cartoPositron, 'Street': esriWorldStreet, 'Topo': esriTopo };
    const layerControl = L.control.layers(baseMaps, null, { position: 'topright', collapsed: false }).addTo(map);
    const controlEl = layerControl.getContainer();
    const baseList = controlEl.querySelector('.leaflet-control-layers-base');
    if (baseList) { const h = document.createElement('div'); h.className = 'basemap-heading'; h.textContent = 'Basemap'; baseList.prepend(h); }

    const GEOJSON_URL = "https://api.tbc.city/orgs/organization_map.geojson";

    let allFeatures = [];
    let FIELDS = {};
    const el = (s) => document.querySelector(s);
    const $ = (s) => document.querySelectorAll(s);

    const normKey = (s) => String(s||'').toLowerCase().replace(/[\s._-]+/g,'').replace(/[^\p{L}\p{N}]/gu,'');
    function resolveFieldsFromSample(props) {
      const keys = Object.keys(props||{});
      const byNorm = new Map(keys.map(k => [normKey(k), k]));
      const pick = (...c) => { for (const cand of c) { const k = normKey(cand); if (byNorm.has(k)) return byNorm.get(k); } for (const [nk, orig] of byNorm.entries()) if (c.some(cand => nk.includes(normKey(cand)))) return orig; return null; };
      return {
        name: pick("Organization Name","Org Name","Name","organization_name"),
        website: pick("Website","URL","Link","website"),
        category: pick("Category","Categories","category"),
        denomination: pick("Denomination","Denominations","denomination"),
        type: pick("Organization Type","Type","organization_type"),
        address: pick("Full Address","Address","full_address"),
        county: pick("County","county"),
        network: pick("Network Name","Network","network_name"),
      };
    }

    function normalizeTags(v) { if (!v && v !== 0) return []; if (Array.isArray(v)) return v.map(x => String(x).trim()).filter(Boolean); return String(v).split(/[,;|]/).map(s => s.trim()).filter(Boolean); }
    function uniqueSortedTags(features, fieldKey) { const set = new Set(); for (const f of features) normalizeTags(f.properties?.[fieldKey]).forEach(t => set.add(t)); return Array.from(set).sort((a,b)=>a.localeCompare(b, undefined, {sensitivity:'base'})); }
    function buildTagList(container, tags, groupKey) {
      container.innerHTML = "";
      tags.forEach(tag => {
        const id = `${groupKey}-${tag.replace(/\s+/g,"_")}`;
        const label = document.createElement('label');
        label.className = 'tag-pill colored';
        label.setAttribute('for', id);
        const bg = colorForTag(groupKey, tag);
        const fg = contrastText(bg);
        label.style.background = bg;
        label.style.color = fg;
        label.style.borderColor = 'transparent';

        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = id; input.value = tag; input.dataset.group = groupKey;

        const span = document.createElement('span'); span.textContent = tag;

        label.appendChild(input); label.appendChild(span); container.appendChild(label);
      });
    });
    }
    function getSelected(groupKey) { return Array.from(document.querySelectorAll(`input[type="checkbox"][data-group="${groupKey}"]:checked`)).map(i => i.value); }

    function featureMatchesSelections(f, sel) {
      const p = f.properties || {};
      const county = normalizeTags(p[FIELDS.county]);
      const network = normalizeTags(p[FIELDS.network]);
      const type = normalizeTags(p[FIELDS.type]);
      const category = normalizeTags(p[FIELDS.category]);
      const denom = normalizeTags(p[FIELDS.denomination]);
      if (sel.county.length && !sel.county.some(t => county.includes(t))) return false;
      if (sel.network.length && !sel.network.some(t => network.includes(t))) return false;
      if (sel.type.length && !sel.type.some(t => type.includes(t))) return false;
      if (sel.category.length && !sel.category.some(t => category.includes(t))) return false;
      if (sel.denomination.length && !sel.denomination.some(t => denom.includes(t))) return false;
      return true;
    }

    const palette30 = ['#1f77b4','#ff7f0e','#2ca02c','#d62728','#9467bd','#8c564b','#e377c2','#7f7f7f','#bcbd22','#17becf','#393b79','#637939','#8c6d31','#843c39','#7b4173','#3182bd','#31a354','#756bb1','#636363','#e6550d','#9edae5','#c7c7c7','#bc80bd','#ffed6f','#a6cee3','#b2df8a','#fb9a99','#fdbf6f','#cab2d6','#6a3d9a'];
    function hashIndex(str, m){ let h=0; for(let i=0;i<str.length;i++) h=(h*31 + str.charCodeAt(i))|0; return Math.abs(h)%m; }
    function colorForFeature(props) { const key = `${props[FIELDS.name]||''}|${props[FIELDS.address]||''}`; return palette30[ hashIndex(key, palette30.length) ]; }
    // === Tag color mapping (per-group, deterministic, shared with filters & popup) ===
    const TAG_COLORS = { county: new Map(), network: new Map(), type: new Map(), category: new Map(), denomination: new Map() };
    function canonicalizeTag(groupKey, tag){
      let t = String(tag||'').trim();
      if (!t) return '';
      if (groupKey === 'county') t = t.replace(/\s*county$/i, '');
      return t.toLowerCase();
    }
    function computeTagColors(features){
      const groups = ['county','network','type','category','denomination'];
      groups.forEach(g => { TAG_COLORS[g].clear(); });
      const uniq = (arr) => Array.from(new Set(arr));
      const getTags = (g) => {
        const key = FIELDS[g];
        if (!key) return [];
        const raw = uniqueSortedTags(features, key);
        return uniq(raw.map(t => canonicalizeTag(g, t)).filter(Boolean));
      };
      const groupsTags = {
        county: getTags('county'),
        network: getTags('network'),
        type: getTags('type'),
        category: getTags('category'),
        denomination: getTags('denomination'),
      };
      Object.keys(groupsTags).forEach(g => {
        groupsTags[g].forEach((canon, idx) => {
          TAG_COLORS[g].set(canon, palette30[idx % palette30.length]);
        });
      });
    }
    function colorForTag(groupKey, tag){
      const canon = canonicalizeTag(groupKey, tag);
      const map = TAG_COLORS[groupKey];
      if (map && map.has(canon)) return map.get(canon);
      // Fallback to hash-based color (should rarely be used once computeTagColors runs)
      return palette30[ hashIndex(canon, palette30.length) ];
    }
    function contrastText(hex){ // simple YIQ contrast
      try {
        const h = hex.replace('#',''); const r=parseInt(h.slice(0,2),16), g=parseInt(h.slice(2,4),16), b=parseInt(h.slice(4,6),16);
        const yiq = (r*299 + g*587 + b*114)/1000; return yiq >= 150 ? '#111' : '#fff';
      } catch { return '#fff'; }
    }

    // === Church icon (single path to avoid seam; shorter building to y=18) ===
    function churchSVG(color, size=20){
      const s = Number(size) || 20;
      return `\n<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="${s}" height="${s}" aria-hidden="true">\n  <path d="M7 10 L12 4 L17 10 L17 18 L7 18 Z" fill="${color}"/>\n</svg>`;
    }
    function makeChurchIcon(color){
      const html = churchSVG(color, 20);
      return L.divIcon({
        html,
        className: 'church-marker',
        iconSize: [20, 20],
        iconAnchor: [10, 18], // bottom-center aligns to new bottom at y=18
        popupAnchor: [0, -18]
      });
    }

    function chipsRow(props){
      const typeVals = normalizeTags(props[FIELDS.type]);
      const countyValsRaw = normalizeTags(props[FIELDS.county]);
      const networkVals = normalizeTags(props[FIELDS.network]);
      const categoryVals = normalizeTags(props[FIELDS.category]);
      const denomVals = normalizeTags(props[FIELDS.denomination]);
      const makeChip = (groupKey, text, displayText) => {
        const bg = colorForTag(groupKey, text);
        const fg = contrastText(bg);
        return `<span class=\"chip chip-colored\" style=\"background:${bg};color:${fg};\">${displayText ?? text}</span>`;
      };
      const chips = [
        ...typeVals.map(t => makeChip('type', t)),
        ...countyValsRaw.map(t => makeChip('county', t, /county\b/i.test(t) ? t : `${t} County`)),
        ...networkVals.map(t => makeChip('network', t)),
        ...categoryVals.map(t => makeChip('category', t)),
        ...denomVals.map(t => makeChip('denomination', t)),
      ];
      if (!chips.length) return '';
      return `<div class=\"tag-strip\">${chips.join('')}</div>`;
    };
      const chips = [
        ...typeVals.map(makeChip),
        ...countyVals.map(makeChip),
        ...networkVals.map(makeChip),
        ...categoryVals.map(makeChip),
        ...denomVals.map(makeChip),
      ];
      if (!chips.length) return '';
      return `<div class="tag-strip">${chips.join('')}</div>`;
    }

    function infoHtml(props) {
      const name = props[FIELDS.name] || "(No name)";
      const website = props[FIELDS.website];
      const address = props[FIELDS.address];
      return `<div class="popup">
        <h3>${name}</h3>
        ${address ? `<div class="field-row"><b>Address:</b> ${address}</div>` : ""}
        ${website ? `<div class="field-row"><b>Website:</b> <a href="${website}" target="_blank" rel="noopener">${website}</a></div>` : ""}
        ${chipsRow(props)}
      </div>`;
    }

    const markersLayer = L.layerGroup().addTo(map);
    function clearMarkers(){ markersLayer.clearLayers(); }

    // ===== Bottom sheet helpers (from networks map) =====
    const sheetEl = document.getElementById('infoSheet');
    const sheetContentEl = document.getElementById('sheetContent');
    let scrollLockY = 0;
    function lockScroll() { scrollLockY = window.scrollY || document.documentElement.scrollTop || 0; document.body.style.position='fixed'; document.body.style.top=`-${scrollLockY}px`; document.body.style.left='0'; document.body.style.right='0'; document.body.style.width='100%'; document.body.style.overflow='hidden'; document.documentElement.style.overflow='hidden'; }
    function unlockScroll() { document.body.style.position=''; document.body.style.top=''; document.body.style.left=''; document.body.style.right=''; document.body.style.width=''; document.body.style.overflow=''; document.documentElement.style.overflow=''; window.scrollTo(0, scrollLockY); }
    function isMobile() { return window.matchMedia('(max-width: 767.98px)').matches; }
    function openSheet(html){ if (!sheetEl) return; sheetContentEl.innerHTML = html; sheetEl.classList.add('open'); sheetEl.setAttribute('aria-hidden','false'); lockScroll(); }
    function closeSheet(){ if (!sheetEl) return; sheetEl.classList.remove('open'); sheetEl.setAttribute('aria-hidden','true'); unlockScroll(); }
    if (sheetEl) {
      sheetEl.addEventListener('click', (e) => { const t = e.target; if (t.matches('[data-close]')) { e.stopPropagation(); closeSheet(); } }, { passive:false });
    }

    function drawMarkers(features) {
      clearMarkers();
      const pts = [];
      features.forEach(f => {
        const [lng, lat] = f.geometry?.coordinates || [];
        if (typeof lat !== "number" || typeof lng !== "number") return;
        const props = f.properties || {};
        const color = colorForFeature(props);
        const icon = makeChurchIcon(color);
        const m = L.marker([lat, lng], { icon });

        m.on('click', (e) => {
          const html = infoHtml(props);
          if (isMobile()) {
            openSheet(html);
          } else {
            m.bindPopup(html, { maxWidth: 420, closeOnClick: true, autoClose: true }).openPopup();
          }
        });

        markersLayer.addLayer(m);
        pts.push([lat, lng]);
      });
      if (pts.length) map.fitBounds(L.latLngBounds(pts).pad(0.08));
    }

    function applyFilters() {
      const selections = {
        county: getSelected("county"),
        network: getSelected("network"),
        type: getSelected("type"),
        category: getSelected("category"),
        denomination: getSelected("denomination"),
      };
      drawMarkers(allFeatures.filter(f => featureMatchesSelections(f, selections)));
      collapseAllSections();
    }
    function clearFilters() { document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false); applyFilters(); }
    function collapseAllSections() { document.querySelectorAll('#legendPanel details[open]').forEach(d => d.removeAttribute('open')); }

    function preselectFromParams() {
      const params = new URLSearchParams(location.search);
      const preCounty = (params.get('county')||'').split(',').map(s=>s.trim()).filter(Boolean);
      const preNetwork = (params.get('network')||'').split(',').map(s=>s.trim()).filter(Boolean);
      preCounty.forEach(v => {
        const cb = Array.from($('input[type="checkbox"][data-group="county"]')).find(i => i.value.toLowerCase() === v.toLowerCase());
        if (cb) cb.checked = true;
      });
      preNetwork.forEach(v => {
        const cb = Array.from($('input[type="checkbox"][data-group="network"]')).find(i => i.value.toLowerCase() === v.toLowerCase());
        if (cb) cb.checked = true;
      });
      if (preCounty.length || preNetwork.length) applyFilters();
    }

    fetch(GEOJSON_URL, { cache: 'no-cache' })
      .then(r => r.json())
      .then(data => {
        const features = Array.isArray(data?.features) ? data.features : [];
        allFeatures = features;
        if (!features.length) return;

        FIELDS = resolveFieldsFromSample(features[0]?.properties || {});
        // Build per-group color maps so filters and popup chips share identical colors
        computeTagColors(allFeatures);
        buildTagList(el("#list-county"), uniqueSortedTags(features, FIELDS.county), "county");
        buildTagList(el("#list-network"), uniqueSortedTags(features, FIELDS.network), "network");
        buildTagList(el("#list-type"), uniqueSortedTags(features, FIELDS.type), "type");
        buildTagList(el("#list-category"), uniqueSortedTags(features, FIELDS.category), "category");
        buildTagList(el("#list-denomination"), uniqueSortedTags(features, FIELDS.denomination), "denomination");

        drawMarkers(allFeatures);
        preselectFromParams();
      })
      .catch(err => { console.error("Failed to load org GeoJSON:", err); alert("Failed to load organization map data."); });

    el("#applyFilters").addEventListener("click", applyFilters);
    el("#clearFilters").addEventListener("click", clearFilters);

    // Legend interactions
    const legendPanel = document.getElementById('legendPanel');
    const legendToggle = document.getElementById('legendToggle');
    const legendClose = document.getElementById('legendClose');

    L.DomEvent.disableScrollPropagation(legendPanel);
    L.DomEvent.disableClickPropagation(legendPanel);

    function openLegend() {
      if (isMobile()) { legendPanel.classList.add('open'); lockScroll(); }
      legendPanel.classList.remove('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'true');
    }
    function closeLegend() {
      if (isMobile()) { legendPanel.classList.remove('open'); unlockScroll(); }
      legendPanel.classList.add('closed');
      if (legendToggle) legendToggle.setAttribute('aria-expanded', 'false');
    }

    if (legendToggle) legendToggle.addEventListener('click', () => {
      const isHiddenDesktop = legendPanel.classList.contains('closed');
      const isOpenMobile = legendPanel.classList.contains('open');
      (isMobile() ? !isOpenMobile : isHiddenDesktop) ? openLegend() : closeLegend();
    });
    if (legendClose) legendClose.addEventListener('click', closeLegend);

    // Keep popup interactions from bubbling; desktop uses Leaflet popup only
    map.on('popupopen', (e) => {
      const el = e.popup && e.popup.getElement && e.popup.getElement();
      if (!el) return; try { L.DomEvent.disableClickPropagation(el); L.DomEvent.disableScrollPropagation(el); } catch {}
    });
  </script>
</body>
</html>
