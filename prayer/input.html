<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Prayer Request - TBC</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; margin: 0; background: #f9f9f9; color: #111; }
        main { padding: 48px 16px; max-width: 500px; margin: 0 auto; text-align: center; }
        h2 { font-size: 1.8rem; margin-bottom: 24px; color: #bf3426; }
        .card { background: white; padding: 30px; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 4px 12px rgba(0,0,0,0.05); text-align: left; }
        label { font-weight: 700; display: block; margin-bottom: 8px; font-size: 0.9rem; }
        
        /* Container for autocomplete validation */
        .input-group { position: relative; margin-bottom: 20px; }
        input, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        
        /* Validation feedback */
        input:invalid { border-color: #bf3426; }
        .error-msg { color: #bf3426; font-size: 0.8rem; margin-top: -15px; margin-bottom: 15px; display: none; }
        
        .btn { width: 100%; background: #bf3426; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 10px; }
        .btn:hover:not(:disabled) { background: #a22a1f; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    </style>
</head>
<body>
    <div id="navbar-include"></div>
    <script src="/include-nav.js"></script>

    <main>
        <h2>New Prayer Request</h2>
        <div class="card">
            <div class="input-group">
                <label for="leaderSearch">Leader Name</label>
                <input list="leaders" id="leaderSearch" placeholder="Type to search leaders..." autocomplete="off">
                <datalist id="leaders"></datalist>
                <div id="leaderError" class="error-msg">Please select a leader from the existing list.</div>
            </div>

            <label for="requestText">Prayer Request (Text)</label>
            <textarea id="requestText" rows="6" placeholder="Paste the prayer request here..."></textarea>

            <button id="submitBtn" class="btn">Save Request</button>
        </div>
    </main>

    <script>
        const API_URL = "https://prayer-app.tbccities.workers.dev";
        let leaders = [];
        
        // DOM Elements
        const leaderInput = document.getElementById('leaderSearch');
        const errorMsg = document.getElementById('leaderError');
        const submitBtn = document.getElementById('submitBtn');
        const requestText = document.getElementById('requestText');
        
        async function init() {
            try {
                const res = await fetch(`${API_URL}/get-leaders`);
                leaders = await res.json();
                const list = document.getElementById('leaders');
                leaders.forEach(l => {
                    const opt = document.createElement('option');
                    opt.value = l.name;
                    list.appendChild(opt);
                });
            } catch (err) {
                console.error("Failed to load leaders:", err);
            }
        }
        
        // Function to validate the leader selection
        function validateLeader() {
            const leader = leaders.find(l => l.name === leaderInput.value);
            
            if (leaderInput.value !== "" && !leader) {
                // Show error if something is typed but doesn't match a leader
                errorMsg.style.display = 'block';
                leaderInput.style.borderColor = '#bf3426';
                return false;
            } else {
                // Hide error if valid or empty
                errorMsg.style.display = 'none';
                leaderInput.style.borderColor = '#ccc';
                return !!leader;
            }
        }
        
        // Trigger validation when navigating out of the field (blur)
        leaderInput.addEventListener('blur', validateLeader);
        
        // Also validate while typing to clear errors quickly
        leaderInput.addEventListener('input', () => {
            if (errorMsg.style.display === 'block') {
                validateLeader();
            }
        });
        
        submitBtn.onclick = async () => {
            const isValid = validateLeader();
            const text = requestText.value;
            
            if (!isValid) {
                leaderInput.focus();
                return;
            }
        
            if (!text) return alert("Please enter the prayer text.");
        
            const leader = leaders.find(l => l.name === leaderInput.value);
        
            submitBtn.disabled = true;
            submitBtn.innerText = "Saving...";
        
            try {
                const response = await fetch(`${API_URL}/submit-prayer`, {
                    method: "POST",
                    body: JSON.stringify({ leaderId: leader.id, text: text })
                });
                
                if (response.ok) {
                    alert("Prayer request saved successfully.");
                    location.reload();
                } else {
                    throw new Error("Failed to save");
                }
            } catch (err) {
                alert("Error saving request. Please try again.");
                submitBtn.disabled = false;
                submitBtn.innerText = "Save Request";
            }
        };
        
        init();
    </script>
</body>
</html>
